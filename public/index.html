<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Assistant</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(0,0,0,.18);
      --border:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:#a9b4cc;
      --accent:#6aa6ff;
      --danger:#ffb4b4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 600px at 20% 0%, rgba(106,166,255,.14), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg), #070a10);
      color:var(--text);
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px;
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(106,166,255,.45);
      flex:0 0 auto;
    }
    .title{
      margin:0;
      font-size:16px;
      font-weight:750;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    /* Removed the top-right tag entirely */

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      min-height:0;
    }
    @media (max-width: 900px){
      .main{grid-template-columns:1fr}
      .sidebar{order:2}
    }

    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--panel);
      backdrop-filter: blur(8px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .sidebarHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.10);
      color:var(--muted);
      font-size:13px;
    }
    .promptList{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .prompt{
      border:1px solid var(--border);
      background:rgba(0,0,0,.12);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      line-height:1.25;
      font-size:15px;
    }
    .prompt:hover{border-color: rgba(106,166,255,.45)}
    .prompt.used{
      opacity:.45;
      cursor:not-allowed;
    }

    .log{
      flex:1;
      padding:16px;
      overflow:auto;
      background:var(--panel2);
    }
    .msg{
      max-width: 980px;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      margin:10px 0;
      white-space:pre-wrap;
      font-size:17px;
      line-height:1.5;
      background:rgba(0,0,0,.12);
    }
    .msg.you{
      border-color: rgba(106,166,255,.30);
      background: rgba(106,166,255,.08);
    }
    .msg.error{
      border-color: rgba(255,180,180,.35);
      background: rgba(255,0,0,.08);
      color: var(--danger);
    }
    .who{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .typing{
      color:var(--muted);
      font-style:italic;
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--border);
      background:rgba(0,0,0,.10);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      min-height:62px;
      max-height:200px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--text);
      font-size:17px;
      line-height:1.35;
      outline:none;
    }
    textarea:focus{border-color: rgba(106,166,255,.55)}
    .btn{
      height:62px;
      width:62px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(106,166,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .btn:hover{border-color: rgba(106,166,255,.55)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn svg{width:24px;height:24px;fill:var(--text)}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <p class="title">Chat Assistant</p>
      </div>
      <div></div>
    </div>

    <div class="main">
      <div class="card sidebar">
        <div class="sidebarHead">Prompts</div>
        <div class="promptList" id="promptList"></div>
      </div>

      <div class="card">
        <div class="log" id="log"></div>

        <div class="composer">
          <textarea id="input" placeholder="Type or paste a prompt..."></textarea>
          <button class="btn" id="sendBtn" aria-label="Send">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PROMPTS = [
      "Explain how photosynthesis works in about a paragraph.",
      "Create a study plan for a 30 word vocabulary quiz that I have in 3 days.",
      "Solve the following equation using completing the square: x^2 + 7x + 12 = 0",
      "List the 4 greatest causes of World War I.",
      "Summarize act 1 of Romeo and Juliet without spoiling later acts."
    ];

    // URL conditions:
    //  - ?d1  => randomized delay 2–4 seconds
    //  - ?d2  => randomized delay 12–18 seconds
    // We do NOT display the delay anywhere.
    const params = new URLSearchParams(location.search);

    function randIntInclusive(a, b){
      return Math.floor(Math.random() * (b - a + 1)) + a;
    }

    let delaySeconds;
    if (params.has("d2")) delaySeconds = randIntInclusive(12, 18);
    else if (params.has("d1")) delaySeconds = randIntInclusive(2, 4);
    else delaySeconds = randIntInclusive(2, 4); // default to d1-like

    const targetDelayMs = Math.max(0, delaySeconds * 1000);

    const promptList = document.getElementById("promptList");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const log = document.getElementById("log");

    const used = new Set();

    function normalize(s){
      return String(s || "").replace(/\s+/g, " ").trim();
    }

    function addMessage(kind, text, extraClass=""){
      const box = document.createElement("div");
      box.className = `msg ${kind} ${extraClass}`.trim();

      const who = document.createElement("div");
      who.className = "who";
      if (extraClass === "error") who.textContent = "Error";
      else who.textContent = kind === "you" ? "You" : "Assistant";

      const body = document.createElement("div");
      body.textContent = text;

      box.appendChild(who);
      box.appendChild(body);
      log.appendChild(box);
      log.scrollTop = log.scrollHeight;
      return body;
    }

    function renderPrompts(){
      promptList.innerHTML = "";
      PROMPTS.forEach((p) => {
        if (used.has(p)) return; // remove from list once used
        const div = document.createElement("div");
        div.className = "prompt";
        div.textContent = p;
        div.addEventListener("click", () => {
          input.value = p;
          input.focus();
        });
        promptList.appendChild(div);
      });

      // If all used, show nothing (no instructions)
    }

    function typeOut(targetEl, fullText, waitMs, typingMs){
      return new Promise((resolve) => {
        setTimeout(() => {
          const text = fullText;
          const n = text.length;

          if (n === 0 || typingMs <= 0){
            targetEl.textContent = text;
            resolve();
            return;
          }

          const start = performance.now();
          function tick(now){
            const t = now - start;
            const ratio = Math.min(1, t / typingMs);
            const chars = Math.max(0, Math.floor(ratio * n));
            targetEl.textContent = text.slice(0, chars);
            if (ratio < 1) requestAnimationFrame(tick);
            else resolve();
          }
          requestAnimationFrame(tick);
        }, Math.max(0, waitMs));
      });
    }

    async function send(){
      const prompt = normalize(input.value);
      if (!prompt) return;

      // Must match one of the study prompts
      if (!PROMPTS.includes(prompt)){
        addMessage("you", prompt);
        addMessage("ai", "Please use one of the listed prompts.", "error");
        return;
      }

      // Cannot reuse prompts
      if (used.has(prompt)){
        addMessage("you", prompt);
        addMessage("ai", "That prompt has already been used in this session.", "error");
        input.value = "";
        return;
      }

      // Mark used and remove from sidebar
      used.add(prompt);
      renderPrompts();

      addMessage("you", prompt);
      input.value = "";

      sendBtn.disabled = true;
      const bodyEl = addMessage("ai", "…", "typing");

      try{
        const tRequestStart = Date.now();

        const r = await fetch("/api/chat", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt })
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok){
          bodyEl.parentElement.classList.remove("typing");
          bodyEl.parentElement.classList.add("error");
          bodyEl.textContent =
            (data.error === "INVALID_PROMPT")
              ? "Please use one of the listed prompts exactly."
              : (data.error || "Request failed.");
          return;
        }

        const text = data.text || "(No response)";
        const apiMs = Number(data.apiMs || (Date.now() - tRequestStart));

        // Total time = max(random target delay, API time)
        const totalMs = Math.max(targetDelayMs, apiMs);

        // Half wait, half typing
        const halfMs = Math.floor(totalMs / 2);

        // API time already contributes to waiting half
        const waitAfterMs = Math.max(0, halfMs - apiMs);
        const typingMs = Math.max(0, totalMs - halfMs);

        await typeOut(bodyEl, text, waitAfterMs, typingMs);
        bodyEl.parentElement.classList.remove("typing");
      } catch (e){
        bodyEl.parentElement.classList.remove("typing");
        bodyEl.parentElement.classList.add("error");
        bodyEl.textContent = "Network error. Please try again.";
      } finally{
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // Greeting message (with !)
    addMessage("ai", "Hello! I can answer any questions you have. Send a prompt when you're ready.");

    renderPrompts();
  </script>
</body>
</html>
